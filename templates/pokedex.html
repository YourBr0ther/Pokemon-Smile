<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pok√©dex</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>

<body>
    <div class="main-menu">
        <h1 id="pokedexTitle" class="title">Loading Pok√©dex...</h1>
        <div id="pokedexContent">
            <p>Loading caught Pok√©mon...</p>
        </div>
        <a href="/" class="back-btn">‚Üê Back to Main Menu</a>
    </div>

    <audio id="pokedex-bgm" autoplay loop></audio>

    <script>
        const pokedexTracks = [
            '/static/music/BGM Pokedex 01.mp3',
            '/static/music/BGM Pokedex 02.mp3',
            '/static/music/BGM Pokedex 03.mp3',
            '/static/music/BGM Pokedex 04.mp3',
            '/static/music/BGM Pokedex 05.mp3',
            '/static/music/BGM Pokedex 06.mp3'
        ];

        function playRandomPokedexBGM() {
            const track = pokedexTracks[Math.floor(Math.random() * pokedexTracks.length)];
            const audio = document.getElementById('pokedex-bgm');
            audio.src = track;
            audio.play().catch(err => console.log("Audio autoplay was blocked:", err));
        }

        const state = {
            currentGen: null,
            currentType: null,
            caughtPokemon: []
        };

        const generations = [1, 2, 3, 4, 5, 6, 7, 8, 9];
        const types = [
            { name: "fire", label: "üî• Fire" }, { name: "water", label: "üíß Water" },
            { name: "grass", label: "üåø Grass" }, { name: "electric", label: "‚ö° Electric" },
            { name: "psychic", label: "üîÆ Psychic" }, { name: "flying", label: "üïäÔ∏è Flying" },
            { name: "bug", label: "üêû Bug" }, { name: "dark", label: "üåë Dark" },
            { name: "dragon", label: "üêâ Dragon" }, { name: "fairy", label: "üßö Fairy" },
            { name: "fighting", label: "üèã Fighting" }, { name: "ghost", label: "üëª Ghost" },
            { name: "ground", label: "üåç Ground" }, { name: "ice", label: "‚ùÑÔ∏è Ice" },
            { name: "normal", label: "‚≠ï Normal" }, { name: "poison", label: "‚ò† Poison" },
            { name: "rock", label: "ü™® Rock" }, { name: "steel", label: "‚öô Steel" }
        ];

        async function loadCaughtPokemon() {
            try {
                const profileRes = await fetch('/api/get_profiles');
                const profiles = await profileRes.json();
                if (profiles.length === 0) throw new Error("No profiles found");

                const profileName = profiles[0].name;
                const pokedexRes = await fetch(`/api/get_pokedex/${profileName}`);
                state.caughtPokemon = await pokedexRes.json();

                showGenerationSelector();
            } catch (err) {
                console.error("Failed to load Pok√©mon:", err);
                document.getElementById("pokedexContent").innerHTML = '<p>Failed to load caught Pok√©mon.</p>';
            }
        }

        function showGenerationSelector() {
            state.currentGen = null;
            state.currentType = null;
            document.getElementById("pokedexTitle").textContent = "Select a Generation";
            const container = document.getElementById("pokedexContent");
            container.innerHTML = '<div class="gen-buttons" id="generationSelector"></div>';
            const selector = document.getElementById("generationSelector");
            generations.forEach(gen => {
                const btn = document.createElement("a");
                btn.href = "#";
                btn.className = "gen-btn";
                btn.textContent = `Gen ${gen}`;
                btn.onclick = () => showTypeSelector(gen);
                selector.appendChild(btn);
            });
        }

        function showTypeSelector(gen) {
            state.currentGen = gen;
            state.currentType = null;
            document.getElementById("pokedexTitle").textContent = `Gen ${gen} ‚Äî Choose a Type`;
            const container = document.getElementById("pokedexContent");
            container.innerHTML = '<div class="type-buttons" id="typeSelector"></div>';
            const selector = document.getElementById("typeSelector");
            types.forEach(t => {
                const btn = document.createElement("a");
                btn.href = "#";
                btn.className = "type-btn";
                btn.textContent = t.label;
                btn.onclick = () => showPokemonList(t.name);
                selector.appendChild(btn);
            });

            const backBtn = document.createElement("a");
            backBtn.href = "#";
            backBtn.className = "back-btn";
            backBtn.textContent = "‚Üê Back to Generations";
            backBtn.onclick = showGenerationSelector;
            container.appendChild(backBtn);
        }

        function showPokemonList(type) {
            state.currentType = type;
            const titleType = types.find(t => t.name === type)?.label || type;
            document.getElementById("pokedexTitle").textContent = `${titleType} Pok√©mon - Gen ${state.currentGen}`;
            const container = document.getElementById("pokedexContent");
            container.innerHTML = '<div class="pokemon-grid" id="pokemonGrid"></div>';

            const grid = document.getElementById("pokemonGrid");
            const filtered = state.caughtPokemon.filter(p => {
                return parseInt(p.generation) === state.currentGen && p.types.map(t => t.toLowerCase()).includes(type);
            });

            if (filtered.length === 0) {
                grid.innerHTML = '<p>No Pok√©mon of this type caught yet!</p>';
            } else {
                filtered.forEach(p => {
                    const card = document.createElement("div");
                    card.className = "pokemon-card";
                    card.innerHTML = `<img src="${p.sprite}" alt="${p.name}"><p>${p.name}</p>`;
                    card.onclick = () => showPokemonPopup(p);
                    grid.appendChild(card);
                });
            }

            const backBtn = document.createElement("a");
            backBtn.href = "#";
            backBtn.className = "back-btn";
            backBtn.textContent = `‚Üê Back to Types`;
            backBtn.onclick = () => showTypeSelector(state.currentGen);
            container.appendChild(backBtn);
        }

        function showPokemonPopup(pokemon) {
            const overlay = document.createElement("div");
            overlay.className = "popup-overlay";
            overlay.style.display = "flex";
            const popup = document.createElement("div");
            popup.className = "popup-box";
            popup.innerHTML = `
                <h2>${pokemon.name}</h2>
                <img src="${pokemon.sprite}" alt="${pokemon.name}">
                <div>Types: ${pokemon.types.map(t => `<span class='type-badge'>${t}</span>`).join('')}</div>
                <button onclick="this.closest('.popup-overlay').remove()">Close</button>
            `;
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
        }

        window.addEventListener('DOMContentLoaded', () => {
            playRandomPokedexBGM();
            loadCaughtPokemon();
        });
    </script>
</body>
</html>
